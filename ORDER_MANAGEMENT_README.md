# Система управления заказами с бронированием товаров

## Обзор изменений

Реализована полноценная система управления заказами с бронированием товаров и автоматической отменой просроченных заказов.

## Основные функции

### 1. Бронирование товаров
- При оформлении заказа товары автоматически резервируются
- Добавлено поле `reserved_quantity` в таблицу `products`
- Товары недоступны для покупки другими пользователями пока в резерве

### 2. Ограничение времени на оплату
- У каждого заказа есть 5 часов на оплату
- Добавлено поле `expires_at` в таблицу `orders`
- Автоматическое истечение заказов

### 3. Уведомления в Telegram

#### Для администратора:
- Получает уведомление о новом заказе с кнопками:
  - ✅ "Подтвердить оплату" 
  - ❌ "Отменить заказ"
- Показывается информация о клиенте, товарах и времени истечения

#### Для клиента:
- Подтверждение создания заказа
- Уведомление о 5-часовом лимите на оплату
- Уведомление о подтверждении или отмене оплаты

### 4. Управление статусами заказов

#### При подтверждении оплаты:
- Статус заказа изменяется на `completed`
- Товары окончательно списываются со склада
- Резерв снимается

#### При отмене заказа:
- Статус заказа изменяется на `cancelled` 
- Товары возвращаются на склад
- Резерв снимается

### 5. Автоматическая очистка просроченных заказов

#### Artisan команда:
```bash
php artisan orders:cancel-expired
```

#### Планировщик:
- Запускается автоматически каждые 15 минут
- Отменяет все просроченные заказы
- Возвращает товары на склад

## Новые модели и методы

### Product Model
- `reserved_quantity` - количество зарезервированного товара
- `getAvailableQuantityAttribute()` - доступное количество
- `canReserve($quantity)` - проверка возможности резерва
- `reserve($quantity)` - резервирование товара
- `unreserve($quantity)` - снятие резерва
- `confirmPurchase($quantity)` - подтверждение покупки

### Order Model  
- `expires_at` - время истечения заказа
- `isExpired()` - проверка истечения
- `scopeExpired()` - поиск просроченных заказов
- `cancelAndUnreserve()` - отмена с возвратом товаров
- `getTimeUntilExpirationAttribute()` - время до истечения

## Файлы изменений

### Миграции:
- `add_reserved_quantity_to_products_table.php`
- `add_expires_at_to_orders_table.php`

### Контроллеры:
- `CartController.php` - обновлен процесс checkout
- `TelegramWebhookController.php` - новый контроллер для webhook

### Сервисы:
- `TelegramBotService.php` - добавлены методы для кнопок

### Команды и Jobs:
- `CancelExpiredOrders.php` - Artisan команда
- `CancelExpiredOrdersJob.php` - фоновая задача
- `Kernel.php` - планировщик задач

### Маршруты:
- `/telegram/webhook/{bot}` - webhook для Telegram

## Как это работает

1. **Оформление заказа:**
   - Клиент нажимает "Оформить заказ" в Mini App
   - Товары резервируются на 5 часов
   - Создается заказ со статусом `pending`
   - Отправляются уведомления в Telegram

2. **Подтверждение оплаты:**
   - Администратор нажимает "Подтвердить оплату" в Telegram
   - Товары окончательно списываются
   - Статус заказа изменяется на `completed`
   - Клиент получает уведомление об успешной оплате

3. **Автоматическая отмена:**
   - Если оплата не подтверждена в течение 5 часов
   - Заказ автоматически отменяется планировщиком
   - Товары возвращаются на склад

## Настройка webhook

Для работы кнопок в Telegram нужно настроить webhook:

```php
// В TelegramBotService уже есть методы:
$bot->setWebhook('https://yourdomain.com/telegram/webhook/' . $bot->id);
```

## Тестирование

Для тестирования можно запустить команду вручную:
```bash
php artisan orders:cancel-expired
```

Или запустить планировщик в режиме разработки:
```bash
php artisan schedule:work
```